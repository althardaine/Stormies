@{
    ViewBag.Title = "Game";
}
<h2 id ="yourName">Stormies!!!</h2>
<div class="container">
    <input type="text" id="playerName" />
    <input type="button" id="joinGame" value="Join" />
    <ul id="players"></ul>
</div>

<div id="game-area"></div>

@section scripts {
    <script src="../../Scripts/jquery.signalR-2.2.0.min.js"></script>
    <script src="../../Scripts/phaser.js"></script>
    <script src="/signalr/hubs"></script>

    <script type="text/javascript">

    $(function () {

        window.onload = function () {

            var game = new Phaser.Game(800, 600, Phaser.AUTO, 'phaser-example', { preload: preload, create: create, update: update });

            function preload() {

                game.load.tilemap('stormies', '../../Map/StormiesMap.json', null, Phaser.Tilemap.TILED_JSON);
                game.load.image('tiles', '../../Tiles/stormies.png');

            }

            var map;
            var layer;
            var cursors;

            function create() {

                game.stage.backgroundColor = '#787878';
                map = game.add.tilemap('stormies');
                map.addTilesetImage('StormiesTiles', 'tiles');
                layer = map.createLayer('World1');
                layer.resizeWorld();
                layer.wrap = true;

                cursors = game.input.keyboard.createCursorKeys();

            }

            function update() {

                if (cursors.left.isDown) {
                    game.camera.x -= 8;
                }
                else if (cursors.right.isDown) {
                    game.camera.x += 8;
                }

                if (cursors.up.isDown) {
                    game.camera.y -= 8;
                }
                else if (cursors.down.isDown) {
                    game.camera.y += 8;
                }

            }
        }

        var game = $.connection.chatHub;

        game.client.updateGameState = function (gameState) {
            $('#players').empty();
            $('#yourName').empty();
            $('#yourName').append(htmlEncode("Stormies!!!"));
            for (var playerIp in gameState.Players) {
                if (playerIp === '@Request.UserHostAddress') {
                    $('#yourName').append(htmlEncode(" Hello " + gameState.Players[playerIp].Name) +
                        " Health: " + gameState.Players[playerIp].Health);
                }
                $('#players').append('<li>' + htmlEncode(gameState.Players[playerIp].Name) + " " + htmlEncode(playerIp) + '</li>');
            };

        };

        game.client.passErrorMessage = function (message) {
            alert(message);
        };

        $('#message').focus();

        $.connection.hub.start().done(function () {
            $('#joinGame').click(function () {
                game.server.joinRequest($('#playerName').val(), '@Request.UserHostAddress');
            });
            $(document).ready(function () {
                game.server.getGameState();
            });
            $(window).bind('beforeunload', function () {
                game.server.leaveRequest('@Request.UserHostAddress');
            });
            $(document).keypress(function (e) {
                if (e.which === 49) {
                    game.server.firstSkillUsed('@Request.UserHostAddress');
                }
            });
        });
    });

    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }
    </script>
}